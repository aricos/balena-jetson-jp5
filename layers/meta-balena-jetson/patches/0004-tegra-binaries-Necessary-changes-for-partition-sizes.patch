From 1b5b30ca2c7034d2525cf48e6832d66f5af4fa83 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Mon, 9 Jan 2023 15:45:20 +0100
Subject: [PATCH 04/11] tegra-binaries: Necessary changes for partition sizes

Signed-off-by: Alexandru Costache <alexandru@balena.io>
---
 .../files/partition_specification194.txt      | 50 +++++++-------
 .../tegra-binaries/files/resinOS-flash194.xml | 68 +++++++++----------
 2 files changed, 60 insertions(+), 58 deletions(-)

diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194.txt b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194.txt
index 924198d..b90d573 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194.txt
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194.txt
@@ -1,31 +1,33 @@
 mts-mce:mce_c10_prod_cr_sigheader.bin.encrypt:512000
-mts-mce_b:mce_c10_prod_cr_sigheader.bin.encrypt:512000
 mts-proper:mts_c10_prod_cr_sigheader.bin.encrypt:4194304
-mts-proper_b:mts_c10_prod_cr_sigheader.bin.encrypt:4194304
-cpu-bootloader:uefi_jetson_sigheader.bin.encrypt:6430720
-cpu-bootloader_b:uefi_jetson_sigheader.bin.encrypt:6430720
-bootloader-dtb:[DTB_NAME]_sigheader.dtb.encrypt:1179648
-bootloader-dtb_b:[DTB_NAME]_sigheader.dtb.encrypt:1179648
-secure-os:tos-optee_t194_sigheader.img.encrypt:2097152
-secure-os_b:tos-optee_t194_sigheader.img.encrypt:2097152
-eks:eks_sigheader.img.encrypt:131072
-eks_b:eks_sigheader.img.encrypt:131072
-bpmp-fw:bpmp-2_t194_sigheader.bin.encrypt:2097152
-bpmp-fw_b:bpmp-2_t194_sigheader.bin.encrypt:2097152
-bpmp-fw-dtb:tegra194-a02-bpmp-p2888-a04_lz4_sigheader.dtb.encrypt:2097152
-bpmp-fw-dtb_b:tegra194-a02-bpmp-p2888-a04_lz4_sigheader.dtb.encrypt:2097152
+cpu-bootloader:uefi_jetson_sigheader.bin.encrypt:4194304
+bootloader-dtb:[DTB_NAME]_sigheader.dtb.encrypt:1048576
+secure-os:tos-optee_t194_sigheader.img.encrypt:2621440
+eks:eks_sigheader.img.encrypt:65536
+bpmp-fw:bpmp-2_t194_sigheader.bin.encrypt:3145728
+bpmp-fw-dtb:tegra194-a02-bpmp-p2888-a04_lz4_sigheader.dtb.encrypt:1048576
 xusb-fw:xusb_sil_rel_fw_sigheader.encrypt:262144
-xusb-fw_b:xusb_sil_rel_fw_sigheader.encrypt:262144
 rce-fw:camera-rtcpu-t194-rce_sigheader.img.encrypt:2097152
-rce-fw_b:camera-rtcpu-t194-rce_sigheader.img.encrypt:2097152
-adsp-fw:adsp-fw_sigheader.bin.encrypt:4194304
-adsp-fw_b:adsp-fw_sigheader.bin.encrypt:4194304
+adsp-fw:adsp-fw_sigheader.bin.encrypt:2097152
 sce-fw:none.bin:1048576
-sce-fw_b:none.bin:1048576
-sc7:warmboot_t194_prod_sigheader.bin.encrypt:6291456
-sc7_b:warmboot_t194_prod_sigheader.bin.encrypt:6291456
-kernel:none.bin:67108864
-kernel_b:none.bin:67108864
+sc7:warmboot_t194_prod_sigheader.bin.encrypt:262144
+kernel:none.bin:67112960
 kernel-dtb:none.bin:524288
+reserved_for_chain_A_user:none.bin:144570368
+mts-mce_b:mce_c10_prod_cr_sigheader.bin.encrypt:512000
+mts-proper_b:mts_c10_prod_cr_sigheader.bin.encrypt:4194304
+cpu-bootloader_b:uefi_jetson_sigheader.bin.encrypt:4194304
+bootloader-dtb_b:[DTB_NAME]_sigheader.dtb.encrypt:1048576
+secure-os_b:tos-optee_t194_sigheader.img.encrypt:2621440
+eks_b:eks_sigheader.img.encrypt:65536
+bpmp-fw_b:bpmp-2_t194_sigheader.bin.encrypt:3145728
+bpmp-fw-dtb_b:tegra194-a02-bpmp-p2888-a04_lz4_sigheader.dtb.encrypt:1048576
+xusb-fw_b:xusb_sil_rel_fw_sigheader.encrypt:262144
+rce-fw_b:camera-rtcpu-t194-rce_sigheader.img.encrypt:2097152
+adsp-fw_b:adsp-fw_sigheader.bin.encrypt:2097152
+sce-fw_b:none.bin:1048576
+sc7_b:warmboot_t194_prod_sigheader.bin.encrypt:262144
+kernel_b:none.bin:67112960
 kernel-dtb_b:none.bin:524288
-PADDING:none.bin:4722688
+reserved_for_chain_B_user:none.bin:144570368
+uefi_variables:none.bin:131072
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
index 6b9e865..0ffd877 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
@@ -232,7 +232,7 @@
         <partition name="mts-mce" type="mts_mce" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 163840 </size>
+            <size> 512000 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -265,7 +265,7 @@
         <partition name="bootloader-dtb" type="bl_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <size> 1048576 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -295,7 +295,7 @@
         <partition name="bpmp-fw" type="bpmp_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1572864 </size>
+            <size> 3145728 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -316,7 +316,7 @@
         <partition name="xusb-fw" type="xusb_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 163840 </size>
+            <size> 262144 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -356,7 +356,7 @@
         <partition name="sc7" type="WB0" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 131072 </size>
+            <size> 262144 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -366,13 +366,13 @@
         <partition name="kernel" type="kernel">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <size> 67112960 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <description> **Required.** Chain A; contains the Linux kernel. </description>
         </partition>
-        <partition name="kernel-dtb" type="kernel_dtb">
+        <partition name="kernel-dtb" type="kernel_dtb" oem_sign=true>
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 524288 </size>
@@ -382,11 +382,19 @@
             <filename> DTB_NAME </filename>
             <description> **Required.** Chain A; contains kernel device tree blob. </description>
         </partition>
+        <partition name="reserved_for_chain_A_user" type="data">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 144570368 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <description> **Required.** Reserved space for chain A on user device. </description>
+        </partition>
         <partition name="mts-mce_b" type="mts_mce" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <start_location> 0x708400000 </start_location> <!-- aligned to 0x100000 -->
-            <size> 163840 </size>
+            <size> 512000 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -419,7 +427,7 @@
         <partition name="bootloader-dtb_b" type="bl_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <size> 1048576 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -449,7 +457,7 @@
         <partition name="bpmp-fw_b" type="bpmp_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1572864 </size>
+            <size> 3145728 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -470,7 +478,7 @@
         <partition name="xusb-fw_b" type="xusb_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 163840 </size>
+            <size> 262144 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -510,7 +518,7 @@
         <partition name="sc7_b" type="WB0" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 131072 </size>
+            <size> 262144 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -520,13 +528,13 @@
         <partition name="kernel_b" type="kernel">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <size> 67112960 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <description> **Required.** Chain B; contains the Linux kernel. </description>
         </partition>
-        <partition name="kernel-dtb_b" type="kernel_dtb">
+        <partition name="kernel-dtb_b" type="kernel_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 524288 </size>
@@ -536,37 +544,29 @@
             <filename> DTB_NAME </filename>
             <description> **Required.** Chain B; contains kernel device tree blob. </description>
         </partition>
-        <partition name="uefi_variables" type="data">
+        <partition name="reserved_for_chain_B_user" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 131072 </size>
+            <size> 144570368 </size>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Contains UEFI variable store with configuration data.
-              </description>
-        </partition>
-        <partition name="esp" type="data">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 512 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** EFI system partition with L4T Launcher. </description>
+            <description> **Required.** Reserved space for chain B on user device. </description>
         </partition>
-        <partition name="PADDING" type="data">
+        <partition name="uefi_variables" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 512 </size>
+            <size> 131072 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
+            <description> **Required.** Contains UEFI variable store with configuration data.
+              </description>
         </partition>
         <partition name="resin-boot" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 20971520 </size>
+            <size> 125829120 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -574,7 +574,7 @@
         <partition name="resin-rootA" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 20971520 </size>
+            <size> 499122176 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
@@ -582,7 +582,7 @@
         <partition name="resin-rootB" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 20971520 </size>
+            <size> 499122176 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-- 
2.37.2

