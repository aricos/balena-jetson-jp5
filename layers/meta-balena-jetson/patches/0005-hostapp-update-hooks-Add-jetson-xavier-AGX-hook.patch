From a5f2a3c4aef6b3ad2ff5f8c2841bf6ad7dcd5dc5 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Tue, 10 Jan 2023 16:58:37 +0100
Subject: [PATCH 05/11] hostapp-update-hooks: Add jetson xavier AGX hook

Signed-off-by: Alexandru Costache <alexandru@balena.io>
---
 .../files/99-resin-bootfiles-jetson-xavier    | 80 +++++++++++++++++++
 .../hostapp-update-hooks.bbappend             |  8 ++
 2 files changed, 88 insertions(+)
 create mode 100644 layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/files/99-resin-bootfiles-jetson-xavier

diff --git a/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/files/99-resin-bootfiles-jetson-xavier b/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/files/99-resin-bootfiles-jetson-xavier
new file mode 100644
index 0000000..233a315
--- /dev/null
+++ b/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/files/99-resin-bootfiles-jetson-xavier
@@ -0,0 +1,80 @@
+#!/bin/sh
+set -o errexit
+
+# Script which writes the appropriate
+# device tree with embedded cmdline
+# and updates the kernel, as well as
+# the rest of the bootloader binaries
+
+. /usr/libexec/os-helpers-fs
+
+DURING_UPDATE=${DURING_UPDATE:-0}
+bootloader_device="/dev/mmcblk0boot0"
+partspec="/opt/tegra-binaries/partition_specification194.txt"
+bootloader_blob="/opt/tegra-binaries/boot0.img"
+
+info_log()
+{
+    echo "[INFO] $@"
+}
+
+update_needed() {
+    current_update_file=${1}
+    device=${2}
+        update_size=$(ls -al $current_update_file | awk '{print $5}')
+        update_md5sum=$(md5sum $current_update_file | awk '{print $1'})
+        existing_md5sum=$(dd if=$device bs=1 count=$update_size status=none | md5sum | awk '{print $1}')
+
+        if [ ! "$existing_md5sum" = "$update_md5sum" ]; then
+            echo 1
+        else
+            echo 0
+        fi
+}
+
+
+partitions=$(cat "${partspec}")
+
+for n in ${partitions}; do
+    part_name=$(echo $n | cut -d ':' -f 1)
+    file_name=$(echo $n | cut -d ':' -f 2)
+
+    if [ -z "${part_name##*kernel*}" ] || [ $file_name = "none.bin" ]; then
+        continue
+    fi
+
+    file_path=$(get_state_path_from_label $part_name)
+
+    if [ "x$file_path" = "x" ]; then
+        continue
+    fi
+
+    dst="${file_path}"
+    src="/opt/tegra-binaries/$file_name"
+    if [ -e ${dst} ]; then
+        if [ $(update_needed $src $dst) -eq 1 ]; then
+            info_log "Will update ${dst} ..."
+            dd if=${src} of="${dst}"
+            info_log "Updated ${dst}"
+        else
+            info_log "No need to update ${dst}"
+        fi
+    else
+        info_log "Partition ${dst} not found"
+    fi
+done
+
+info_log "Updating boot image on hw partition mmcblk0boot0..."
+
+existing_bootloader_md5sum=$(dd if=$bootloader_device bs=1M status=none | md5sum | awk '{print $1}')
+update_bootloader_md5sum=$(md5sum $bootloader_blob | awk '{print $1}')
+
+if [ ! "$existing_bootloader_md5sum" = "$update_bootloader_md5sum" ]; then
+    echo 0 > /sys/block/mmcblk0boot0/force_ro
+    dd if=$bootloader_blob of=$bootloader_device
+    sync
+    echo 1 > /sys/block/mmcblk0boot0/force_ro
+fi
+
+
+info_log "Done."
diff --git a/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/hostapp-update-hooks.bbappend b/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/hostapp-update-hooks.bbappend
index eb92ea6..fe0394f 100644
--- a/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/hostapp-update-hooks.bbappend
+++ b/layers/meta-balena-jetson/recipes-support/hostapp-update-hooks/hostapp-update-hooks.bbappend
@@ -5,3 +5,11 @@ HOSTAPP_HOOKS:append:jetson-agx-orin-devkit    = " 99-resin-uboot \
 			    99-resin-bootfiles-agx-orin-devkit \
 "
 DEPENDS:append:jetson-agx-orin-devkit = " tegra234-flash-dry"
+
+
+HOSTAPP_HOOKS:append:jetson-xavier    = " 99-resin-uboot \
+                            99-resin-bootfiles-jetson-xavier \
+"
+DEPENDS:append:jetson-agx-orin-devkit = " tegra234-flash-dry"
+
+DEPENDS:append:jetson-xavier = " tegra194-flash-dry"
-- 
2.37.2

