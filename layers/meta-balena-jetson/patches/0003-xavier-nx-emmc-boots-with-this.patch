From 6f483f6e84618d89c6882aa4f6c1a5250b3aab93 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Thu, 29 Dec 2022 15:27:25 +0100
Subject: [PATCH 03/11] xavier nx emmc boots with this

---
 ...4_agx_sd.bindiff => boot0_t194_nx.bindiff} |   0
 .../files/boot0_t194_nx_sd.bindiff            |   0
 .../files/partition_specification194_nxde.txt |   6 +-
 ...partition_specification194_nxde_sdcard.txt |   2 +-
 .../files/resinOS-flash194_nxde.xml           | 522 ++++++++++--------
 .../tegra194-flash-dry_35.1.0.bb              |   2 +-
 .../tegra194-nxde-flash-dry_35.1.0.bb         |  86 ++-
 .../tegra194-nxde-sdcard-flash_35.1.0.bb      |   4 +-
 ...Add-hup-and-rollback-support-xav-nx.patch} |   0
 .../uefi/edk2-firmware-tegra_35.1.0.bbappend  |   6 +-
 .../recipes-core/images/balena-image.inc      |  14 +-
 11 files changed, 359 insertions(+), 283 deletions(-)
 rename layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/{boot0_t194_agx_sd.bindiff => boot0_t194_nx.bindiff} (100%)
 create mode 100644 layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_nx_sd.bindiff
 rename layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra/{0007-Add-hup-and-rollback-support-xav-nx-sd.patch => 0007-Add-hup-and-rollback-support-xav-nx.patch} (100%)

diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_agx_sd.bindiff b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_nx.bindiff
similarity index 100%
rename from layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_agx_sd.bindiff
rename to layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_nx.bindiff
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_nx_sd.bindiff b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_nx_sd.bindiff
new file mode 100644
index 0000000..e69de29
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde.txt b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde.txt
index e3d379d..2c563c4 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde.txt
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde.txt
@@ -1,8 +1,8 @@
 kernel:none.bin:67108864
 kernel_b:none.bin:67108864
-kernel-dtb:[DTBNAME]_sigheader.dtb.encrypt:524288
-kernel-dtb_b:[DTBNAME]_sigheader.dtb.encrypt:524288
-recovery-dtb:[DTBNAME]_sigheader.dtb.encrypt:524288
+kernel-dtb:[DTB_NAME].dtb:524288
+kernel-dtb_b:[DTB_NAME].dtb:524288
+recovery-dtb:[DTB_NAME].dtb:524288
 kernel-bootctrl:none.bin:262144
 kernel-bootctrl_b:none.bin:262144
 PADDING:none.bin:333426688
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde_sdcard.txt b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde_sdcard.txt
index 606e3f7..2c563c4 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde_sdcard.txt
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/partition_specification194_nxde_sdcard.txt
@@ -1,4 +1,4 @@
-kernel:none.bin.encrypt:67108864
+kernel:none.bin:67108864
 kernel_b:none.bin:67108864
 kernel-dtb:[DTB_NAME].dtb:524288
 kernel-dtb_b:[DTB_NAME].dtb:524288
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194_nxde.xml b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194_nxde.xml
index 683b71a..700aaab 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194_nxde.xml
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194_nxde.xml
@@ -1,3 +1,7 @@
+<?xml version="1.0"?>
+
+<!-- Nvidia Tegra Partition Layout Version 1.0.0 -->
+
 <partition_layout version="01.00.0000">
     <device instance="0" type="spi" sector_size="512" num_sectors="65536">
         <partition name="BCT" type="boot_config_table">
@@ -13,460 +17,436 @@
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> MB1FILE </filename>
-            <description> **Required.** Slot A; contains NVIDIA signed MB1 binary. </description>
+            <description> **Required.** Chain A; contains NVIDIA signed MB1 binary. </description>
         </partition>
         <partition name="mb1_b" type="mb1_bootloader">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> MB1FILE </filename>
-            <description> **Required.** Slot B; contains NVIDIA signed MB1 binary. </description>
+            <description> **Required.** Chain B; contains NVIDIA signed MB1 binary. </description>
         </partition>
         <partition name="MB1_BCT" type="mb1_boot_config_table">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Slot A; contains MB1 boot configuration table. </description>
-        </partition>
-        <partition name="MB1_BCT_b" type="mb1_boot_config_table">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 65536 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Slot B; contains MB1 boot configuration table. </description>
+            <description> **Required.** Chain A; contains MB1 boot configuration table.
+              </description>
         </partition>
         <partition name="MEM_BCT" type="mem_boot_config_table">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Slot A; contains memory configuration table. </description>
-        </partition>
-        <partition name="MEM_BCT_b" type="mem_boot_config_table">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 262144 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Slot B; contains memory configuration table. </description>
+            <description> **Required.** Chain A; contains memory configuration table. </description>
         </partition>
         <partition name="spe-fw" type="spe_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> SPEFILE </filename>
-            <description> **Required.** Slot A; contains BPMP SPE-FW binary. </description>
-        </partition>
-        <partition name="spe-fw_b" type="spe_fw" oem_sign="true">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 262144 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <filename> SPEFILE </filename>
-            <description> **Required.** Slot B; contains BPMP SPE-FW binary. </description>
+            <description> **Required.** Chain A; contains BPMP SPE-FW binary. </description>
         </partition>
         <partition name="mb2" type="mb2_bootloader" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> TEGRABOOT </filename>
-            <description> **Required.** Slot A; contains TegraBoot binary. </description>
-        </partition>
-        <partition name="mb2_b" type="mb2_bootloader" oem_sign="true">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 262144 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <filename> TEGRABOOT </filename>
-            <description> **Required.** Slot B; contains TegraBoot binary. </description>
+            <description> **Required.** Chain A; contains TegraBoot binary. </description>
         </partition>
         <partition name="mts-preboot" type="mts_preboot" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> MTSPREBOOT </filename>
-            <description> **Required.** Slot A; contains Denver preboot firmware. </description>
-        </partition>
-        <partition name="mts-preboot_b" type="mts_preboot" oem_sign="true">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 65536 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <filename> MTSPREBOOT </filename>
-            <description> **Required.** Slot B; contains Denver preboot firmware. </description>
-
+            <description> **Required.** Chain A; contains Denver preboot firmware. </description>
         </partition>
         <partition name="mts-mce" type="mts_mce" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 196608 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> MTS_MCE </filename>
-            <description> **Required.** Slot A; contains microcode associated with boot, power management,
-              and clocks. </description>
-        </partition>
-        <partition name="mts-mce_b" type="mts_mce" oem_sign="true">
-            <allocation_policy> sequential </allocation_policy>
-            <filesystem_type> basic </filesystem_type>
-            <size> 196608 </size>
-            <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
-            <percent_reserved> 0 </percent_reserved>
-            <filename> MTS_MCE </filename>
-            <description> **Required.** Slot B; contains microcode associated with boot, power management,
-              and clocks. </description>
+            <description> **Required.** Chain A; contains microcode associated with boot, power
+              management, and clocks. </description>
         </partition>
         <partition name="mts-proper" type="mts_proper" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 4194304 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> MTSPROPER </filename>
-            <description> **Required.** Slot A; contains microcode associated with execution
+            <description> **Required.** Chain A; contains microcode associated with execution
               and optimization of ARM code. </description>
         </partition>
-        <partition name="mts-proper_b" type="mts_proper" oem_sign="true">
+        <partition name="sc7" type="WB0" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 4194304 </size>
+            <size> 131072 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> MTSPROPER </filename>
-            <description> **Required.** Slot B; contains microcode associated with execution
-              and optimization of ARM code. </description>
+            <filename> WB0BOOT </filename>
+            <description> **Required.** Chain A; contains warm boot firmware. </description>
         </partition>
-        <partition name="sc7" type="WB0" oem_sign="true">
+        <partition name="xusb-fw" type="xusb_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 131072 </size>
+            <size> 196608 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> WB0BOOT </filename>
-            <description> **Required.** Slot A; contains warm boot firmware. </description>
+            <filename> xusb_sil_rel_fw </filename>
+            <description> **Required.** Chain A; contains XUSB firmware file, making XUSB
+              a true USB 3.0 compliant host controller. </description>
         </partition>
-        <partition name="sc7_b" type="WB0" oem_sign="true">
+        <partition name="cpu-bootloader" type="bootloader_stage2" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 131072 </size>
+            <size> 4194304 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> WB0BOOT </filename>
-            <description> **Required.** Slot B; contains warm boot firmware. </description>
+            <filename> TBCFILE </filename>
+            <description> **Required.** Chain A; contains UEFI, the final boot stage CPU Bootloader
+              binary that loads the binary in the kernel partition.  </description>
         </partition>
-        <partition name="SMD" type="smd">
+        <partition name="bootloader-dtb" type="bl_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 4096 </size>
+            <size> 458752 </size>
             <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> slot_metadata.bin </filename>
-            <description> **Required.** Slot A; contains slot status for A/B boot and A/B
-              update. </description>
+            <filename> DTB_NAME </filename>
+            <description> **Required.** Chain A; contains Bootloader device tree blob
+              (DTB). </description>
         </partition>
-        <partition name="SMD_b" type="smd">
+        <partition name="secure-os" type="tos" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 4096 </size>
+            <size> 2621440 </size>
             <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> slot_metadata.bin </filename>
-            <description> **Required.** Slot B; contains slot status for A/B boot and A/B
-              update. </description>
+            <filename> TOSFILE </filename>
+            <description> **Required.** Chain A; contains the trusted OS. </description>
         </partition>
-        <partition name="xusb-fw" type="xusb_fw">
+        <partition name="eks" type="eks" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 196608 </size>
+            <size> 65536 </size>
             <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> xusb_sil_rel_fw </filename>
-            <description> **Required.** Slot A; contains XUSB module’s firmware file, making XUSB
-              a true USB 3.0 compliant host controller. </description>
+            <filename> EKSFILE </filename>
+            <description> **Required.** Chain A; contains the encrypted keys. </description>
         </partition>
-        <partition name="xusb-fw_b" type="xusb_fw">
+        <partition name="adsp-fw" type="ape_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 196608 </size>
+            <size> 1048576 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> xusb_sil_rel_fw </filename>
-            <description> **Required.** Slot B; contains XUSB module’s firmware file, making XUSB
-              a true USB 3.0 compliant host controller. </description>
+            <filename> adsp-fw.bin </filename>
+            <description> **Required.** Chain A; contains ADSP software. </description>
         </partition>
-        <partition name="cpu-bootloader" type="bootloader" oem_sign="true">
+        <partition name="rce-fw" type="rce_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1441792 </size>
+            <size> 1048576 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TBCFILE </filename>
-            <description> **Required.** Slot A; contains CBoot, the final boot stage CPU Bootloader
-              binary that loads the binary in the kernel partition.  </description>
+            <filename> CAMERAFW </filename>
+            <description> **Required.** Chain A; contains `camera-rtcpu-rce` firmware. </description>
         </partition>
-        <partition name="cpu-bootloader_b" type="bootloader" oem_sign="true">
+        <partition name="sce-fw" type="sce_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1441792 </size>
+            <size> 1048576 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TBCFILE </filename>
-            <description> **Required.** Slot B; contains CBoot, the final boot stage CPU Bootloader
-              binary that loads the binary in the kernel partition.  </description>
+<!--            <filename> sce-fw.bin </filename>	-->
+            <description> **Required.** Chain A; contains `camera-rtcpu-sce` firmware. </description>
         </partition>
-        <partition name="bootloader-dtb" type="data" oem_sign="true">
+        <partition name="bpmp-fw" type="bpmp_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 458752 </size>
+            <size> 1572864 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TBCDTB-FILE </filename>
-            <description> **Required.** Slot A; contains Bootloader device tree blob
-              (DTB). </description>
+            <filename> BPFFILE </filename>
+            <description> **Required.** Chain A; contains BPMP firmware. </description>
         </partition>
-        <partition name="bootloader-dtb_b" type="data" oem_sign="true">
+        <partition name="bpmp-fw-dtb" type="bpmp_fw_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 458752 </size>
+            <size> 1048576 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TBCDTB-FILE </filename>
-            <description> **Required.** Slot B; contains Bootloader device tree blob
+            <filename> BPFDTB_FILE </filename>
+            <description> **Required.** Chain A; contains BPMP firmware device tree blob
               (DTB). </description>
         </partition>
-        <partition name="BMP" type="data">
+        <partition name="reserved_for_chain_A_boot" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 196608 </size>
+            <size> 2097152 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> bmp.blob </filename>
-            <description> **Optional.** Slot A; contains BMP images for splash screen display during
-              boot. </description>
+            <description> **Required.** Reserved space for chain A on boot device. </description>
         </partition>
-        <partition name="BMP_b" type="data">
+        <partition name="MB1_BCT_b" type="mb1_boot_config_table">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 196608 </size>
+            <start_location> 0x1480000 </start_location>
+            <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> bmp.blob </filename>
-            <description> **Optional.** Slot B; contains BMP images for splash screen display during
-              boot. </description>
+            <description> **Required.** Chain B; contains MB1 boot configuration table.
+              </description>
         </partition>
-        <partition name="secure-os" type="data" oem_sign="true">
+        <partition name="MEM_BCT_b" type="mem_boot_config_table">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 2621440 </size>
+            <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TOSFILE </filename>
-            <description> **Required.** Slot A; contains the trusted OS. </description>
+            <description> **Required.** Chain B; contains memory configuration table. </description>
         </partition>
-        <partition name="secure-os_b" type="data" oem_sign="true">
+        <partition name="spe-fw_b" type="spe_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 2621440 </size>
+            <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> TOSFILE </filename>
-            <description> **Required.** Slot B; contains the trusted OS. </description>
+            <filename> SPEFILE </filename>
+            <description> **Required.** Chain B; contains BPMP SPE-FW binary. </description>
         </partition>
-        <partition name="eks" type="data" oem_sign="true">
+        <partition name="mb2_b" type="mb2_bootloader" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 65536 </size>
+            <size> 262144 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> EKSFILE </filename>
-            <description> **Optional.** Slot A; contains the encrypted keys. </description>
+            <filename> TEGRABOOT </filename>
+            <description> **Required.** Chain B; contains TegraBoot binary. </description>
         </partition>
-        <partition name="eks_b" type="data" oem_sign="true">
+        <partition name="mts-preboot_b" type="mts_preboot" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> EKSFILE </filename>
-            <description> **Optional.** Slot B; contains the encrypted keys. </description>
+            <filename> MTSPREBOOT </filename>
+            <description> **Required.** Chain B; contains Denver preboot firmware. </description>
         </partition>
-        <partition name="adsp-fw" type="data" oem_sign="true">
+        <partition name="mts-mce_b" type="mts_mce" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 196608 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> adsp-fw.bin </filename>
-            <description> **Required.** Slot A; contains ADSP software. </description>
+            <filename> MTS_MCE </filename>
+            <description> **Required.** Chain B; contains microcode associated with boot, power
+              management, and clocks. </description>
         </partition>
-        <partition name="adsp-fw_b" type="data" oem_sign="true">
+        <partition name="mts-proper_b" type="mts_proper" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 4194304 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> adsp-fw.bin </filename>
-            <description> **Required.** Slot B; contains ADSP software. </description>
+            <filename> MTSPROPER </filename>
+            <description> **Required.** Chain B; contains microcode associated with execution
+              and optimization of ARM code. </description>
         </partition>
-        <partition name="rce-fw" type="data" oem_sign="true">
+        <partition name="sc7_b" type="WB0" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 131072 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> CAMERAFW </filename>
-            <description> **Required.** Slot A; contains `camera-rtcpu-rce` firmware. </description>
+            <filename> WB0BOOT </filename>
+            <description> **Required.** Chain B; contains warm boot firmware. </description>
         </partition>
-        <partition name="rce-fw_b" type="data" oem_sign="true">
+        <partition name="xusb-fw_b" type="xusb_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 196608 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> CAMERAFW </filename>
-            <description> **Required.** Slot B; contains `camera-rtcpu-rce` firmware. </description>
+            <filename> xusb_sil_rel_fw </filename>
+            <description> **Required.** Chain B; contains XUSB firmware file, making XUSB
+              a true USB 3.0 compliant host controller. </description>
         </partition>
-        <partition name="sce-fw" type="data" oem_sign="true">
+        <partition name="cpu-bootloader_b" type="bootloader_stage2" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 4194304 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-<!--            <filename> sce-fw.bin </filename>	-->
-            <description> **Required.** Contains `camera-rtcpu-sce` firmware. </description>
+            <filename> TBCFILE </filename>
+            <description> **Required.** Chain B; contains UEFI, the final boot stage CPU Bootloader
+              binary that loads the binary in the kernel partition.  </description>
         </partition>
-        <partition name="sce-fw_b" type="data" oem_sign="true">
+        <partition name="bootloader-dtb_b" type="bl_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 458752 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-<!--            <filename> sce-fw.bin </filename>	-->
-            <description> **Required.** Contains `camera-rtcpu-sce` firmware. </description>
+            <filename> DTB_NAME </filename>
+            <description> **Required.** Chain B; contains Bootloader device tree blob
+              (DTB). </description>
         </partition>
-        <partition name="bpmp-fw" type="data" oem_sign="true">
+        <partition name="reserved_for_chain_B_boot" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1572864 </size>
+            <size> 655360 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BPFFILE </filename>
-            <description> **Required.** Slot A; contains BPMP firmware. </description>
+            <description> **Required.** Reserved space for chain B on boot device. </description>
         </partition>
-        <partition name="bpmp-fw_b" type="data" oem_sign="true">
+        <partition name="uefi_variables" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1572864 </size>
+            <start_location> 0x1EF0000 </start_location>
+            <size> 131072 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
+            <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BPFFILE </filename>
-            <description> **Required.** Slot B; contains BPMP firmware. </description>
+            <description> **Required.** Contains UEFI variable store with configuration data.
+              </description>
         </partition>
-        <partition name="bpmp-fw-dtb" type="data" oem_sign="true">
+        <partition name="uefi_ftw" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <size> 196608 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 8 </allocation_attribute>
+            <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BPFDTB_FILE </filename>
-            <description> **Required.** Slot A; contains BPMP firmware device tree blob
-              (DTB). </description>
+            <description> **Required.** Contains UEFI FTW storage.
+              </description>
         </partition>
-        <partition name="bpmp-fw-dtb_b" type="data" oem_sign="true">
+        <partition name="BCT-boot-chain_backup" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 1048576 </size>
+            <start_location> 0x1FA0000 </start_location>
+            <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BPFDTB_FILE </filename>
-            <description> **Required.** Slot B; contains BPMP firmware device tree blob
-              (DTB). </description>
+            <description> **Required.** Contains backup of Boot Configuration Table (BCT)
+              for all boot chains. </description>
         </partition>
-        <partition name="CPUBL-CFG" type="data">
+        <partition name="reserved_partition" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Optional.** Contains boot device selection priority list. </description>
+            <description> **Required.** Contains backup of Boot Configuration Table (BCT)
+              for booting from chain B. </description>
         </partition>
-        <partition name="CPUBL-CFG_b" type="data">
+        <partition name="secondary_gpt_backup" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x8 </allocation_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Optional.** Contains boot device selection priority list. </description>
+            <description> **Required.** Contains backup for secondary GPT of the `spi`
+              device. </description>
         </partition>
-        <partition name="VER" type="data">
+        <partition name="VER_b" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
+            <start_location> 0x1FD0000 </start_location>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <partition_attribute> 0 </partition_attribute>
             <allocation_attribute> 8 </allocation_attribute>
@@ -474,16 +454,17 @@
             <filename> VERFILE </filename>
             <description> **Required.** Contains BSP version information. </description>
         </partition>
-        <partition name="VER_b" type="data">
+        <partition name="VER" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 65536 </size>
+            <align_boundary> 65536 </align_boundary>
             <file_system_attribute> 0 </file_system_attribute>
             <partition_attribute> 0 </partition_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
             <filename> VERFILE </filename>
-            <description> **Required.** Contains a redundant copy of BSP version information. </description>
+            <description> **Required.** Contains BSP version information. </description>
         </partition>
         <partition name="secondary_gpt" type="secondary_gpt">
             <allocation_policy> sequential </allocation_policy>
@@ -496,7 +477,9 @@
               device. </description>
         </partition>
     </device>
-    <device type="sdmmc_user" instance="3" sector_size="512" num_sectors="33554432">
+    
+    
+    <device type="sdmmc_user" instance="3" sector_size="512" num_sectors="30777344">
         <partition name="master_boot_record" type="protective_master_boot_record">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
@@ -513,83 +496,143 @@
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Contains primary GPT of the `sdmmc_user` device. All
+            <description> **Required.** Contains primary GPT of the `sdcard` device. All
               partitions defined after this entry are configured in the kernel, and are
               accessible by standard partition tools such as gdisk and parted. </description>
         </partition>
-        <partition name="kernel" type="data" oem_sign="true">
+        <partition name="kernel" id="2" type="kernel">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 67108864 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> LNXFILE </filename>
-            <description> **Required.** Slot A; contains U-Boot, which loads and launches the kernel
+            <description> **Required.** Chain A; contains boot.img (kernel, initrd, etc)
+              which is loaded in when cpu-bootloader failes to launch the kernel
               from the rootfs at `/boot`. </description>
         </partition>
-        <partition name="kernel_b" type="data" oem_sign="true">
+        <partition name="kernel-dtb" type="kernel_dtb">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 67108864 </size>
+            <size> 458752 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> LNXFILE </filename>
-            <description> **Required.** Slot B; contains U-Boot, which loads and launches the kernel
-              from the rootfs at `/boot`. </description>
+            <filename> DTB_NAME </filename>
+            <description> **Required.** Chain A; contains kernel device tree blob. </description>
         </partition>
-        <partition name="kernel-dtb" type="data" oem_sign="true">
+        <partition name="reserved_for_chain_A_user" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size>  524288 </size>
+            <size> 34123776 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> DTB_FILE </filename>
-            <description> **Required.** Slot A; contains kernel device tree blob. </description>
+            <description> **Required.** Reserved space for chain A on user device. </description>
         </partition>
-        <partition name="kernel-dtb_b" type="data" oem_sign="true">
+        <partition name="secure-os_b" type="tos" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <!-- <start_location> 0x6100000 </start_location>  aligned to 0x100000 --> 
+            <size> 2621440 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> DTB_FILE </filename>
-            <description> **Required.** Slot B; contains kernel device tree blob. </description>
+            <filename> TOSFILE </filename>
+            <description> **Required.** Chain B; contains the trusted OS. </description>
         </partition>
-        <partition name="RECDTB-NAME" type="data" oem_sign="true">
+        <partition name="eks_b" type="eks" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 524288 </size>
+            <size> 65536 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> RECDTB-FILE </filename>
-            <description> **Required.** Contains recovery DTB image. </description>
+            <filename> EKSFILE </filename>
+            <description> **Required.** Chain B; contains the encrypted keys. </description>
         </partition>
-        <partition name="BOOTCTRLNAME" type="data">
+        <partition name="adsp-fw_b" type="ape_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 262144 </size>
+            <size> 1048576 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BOOTCTRL-FILE </filename>
-            <description> **Required.** Slot A; contains boot control data. </description>
+            <filename> adsp-fw.bin </filename>
+            <description> **Required.** Chain B; contains ADSP software. </description>
         </partition>
-        <partition name="BOOTCTRLNAME_b" type="data">
+        <partition name="rce-fw_b" type="rce_fw" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 262144 </size>
+            <size> 1048576 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <filename> CAMERAFW </filename>
+            <description> **Required.** Chain B; contains `camera-rtcpu-rce` firmware. </description>
+        </partition>
+        <partition name="sce-fw_b" type="sce_fw" oem_sign="true">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 1048576 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+<!--            <filename> sce-fw.bin </filename>	-->
+            <description> **Required.** Chain B; contains `camera-rtcpu-sce` firmware. </description>
+        </partition>
+        <partition name="bpmp-fw_b" type="bpmp_fw" oem_sign="true">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 1572864 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <filename> BPFFILE </filename>
+            <description> **Required.** Chain B; contains BPMP firmware. </description>
+        </partition>
+        <partition name="bpmp-fw-dtb_b" type="bpmp_fw_dtb" oem_sign="true">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 1048576 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <filename> BPFDTB_FILE </filename>
+            <description> **Required.** Chain B; contains BPMP firmware device tree blob
+              (DTB). </description>
+        </partition>
+        <partition name="kernel_b" type="kernel">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 67108864 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <description> **Required.** Chain B; contains boot.img (kernel, initrd, etc)
+              which is loaded in when cpu-bootloader failes to launch the kernel
+              from the rootfs at `/boot`. </description>
+        </partition>
+        <partition name="kernel-dtb_b" type="kernel_dtb">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 458752 </size>
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <filename> BOOTCTRL-FILE </filename>
-            <description> **Required.** Slot B; contains boot control data. </description>
-         </partition>
-         <partition name="PADDING" type="data">
+            <filename> DTB_NAME </filename>
+            <description> **Required.** Chain B; contains kernel device tree blob. </description>
+        </partition>
+        <partition name="reserved_for_chain_B_user" type="data">
+            <allocation_policy> sequential </allocation_policy>
+            <filesystem_type> basic </filesystem_type>
+            <size> 34078720 </size>
+            <file_system_attribute> 0 </file_system_attribute>
+            <allocation_attribute> 8 </allocation_attribute>
+            <percent_reserved> 0 </percent_reserved>
+            <description> **Required.** Reserved space for chain B on user device. </description>
+        </partition>
+	<partition name="PADDING" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 333426688 </size>
@@ -633,11 +676,12 @@
         <partition name="resin-data" type="data">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
-            <size> 212860928 </size>
+            <size> FILESIZE </size>
             <file_system_attribute> 0 </file_system_attribute>
-            <allocation_attribute> 0x808 </allocation_attribute>
+            <allocation_attribute> 0x8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
         </partition>
+
         <partition name="secondary_gpt" type="secondary_gpt">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
@@ -645,7 +689,7 @@
             <file_system_attribute> 0 </file_system_attribute>
             <allocation_attribute> 8 </allocation_attribute>
             <percent_reserved> 0 </percent_reserved>
-            <description> **Required.** Contains secondary GPT of the `sdmmc_user`
+            <description> **Required.** Contains secondary GPT of the `sdcard`
               device. </description>
         </partition>
     </device>
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
index c1031a9..9bdb88d 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
@@ -5,7 +5,7 @@ LIC_FILES_CHKSUM = "file://${BALENA_COREBASE}/COPYING.Apache-2.0;md5=89aea4e17d9
 
 IMAGE_ROOTFS_ALIGNMENT ?= "4"
 
-BOOT_BINDIFF="boot0_t194_agx.bindiff"
+BOOT_BINDIFF="boot0_t194_nx.bindiff"
 
 DEPENDS = " \
     coreutils-native \
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-flash-dry_35.1.0.bb b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-flash-dry_35.1.0.bb
index 195ef9f..a3977d1 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-flash-dry_35.1.0.bb
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-flash-dry_35.1.0.bb
@@ -1,23 +1,25 @@
-SUMMARY = "Create flash artifacts without flashing the Jetson NX Devkit eMMC"
+SUMMARY = "Create flash artifacts without flashing"
 
 LICENSE = "Apache-2.0"
 LIC_FILES_CHKSUM = "file://${BALENA_COREBASE}/COPYING.Apache-2.0;md5=89aea4e17d99a7cacdbeed46a0096b10"
 
 IMAGE_ROOTFS_ALIGNMENT ?= "4"
 
+BOOT_BINDIFF="boot0_t194_nx_sd.bindiff"
+
 DEPENDS = " \
     coreutils-native \
     virtual/bootloader \
     virtual/kernel \
+    tegra-binaries \
+    tegra-bootfiles \
     tegra-flashtools-native \
     dosfstools-native \
     python3-pyyaml-native \
     mtools-native \
-"
+    "
 
-inherit deploy python3native perlnative
-
-BOOT_BINDIFF="boot0_t194_nx_emmc.bindiff"
+inherit deploy python3native perlnative l4t_bsp
 
 SRC_URI = " \
     file://resinOS-flash194_nxde.xml \
@@ -25,16 +27,15 @@ SRC_URI = " \
     file://${BOOT_BINDIFF} \
 "
 
-FLASHXML = "resinOS-flash194_nxde.xml"
+LNXSIZE ?= "67108864"
 DTBNAME = "tegra194-p3668-all-p3509-0000"
-DTBNAME:photon-xavier-nx = "tegra194-xavier-nx-cti-NGX003"
-DTBNAME_cnx100-xavier-nx = "tegra194-xavier-nx-cnx100"
 KERNEL_DEVICETREE = "${DEPLOY_DIR_IMAGE}/${DTBNAME}.dtb"
 DTBFILE ?= "${@os.path.basename(d.getVar('KERNEL_DEVICETREE', True).split()[0])}"
-LNXSIZE ?= "67108864"
 
 IMAGE_TEGRAFLASH_FS_TYPE ??= "ext4"
 IMAGE_TEGRAFLASH_ROOTFS ?= "${IMGDEPLOYDIR}/${IMAGE_LINK_NAME}.${IMAGE_TEGRAFLASH_FS_TYPE}"
+FLASHTOOLS_DIR = "tegra-flash"
+TOSIMGFILENAME = "tos-optee_t194.img"
 
 LDK_DIR = "${TMPDIR}/work-shared/L4T-${SOC_FAMILY}-${PV}-${PR}/Linux_for_Tegra"
 B = "${WORKDIR}/build"
@@ -43,9 +44,21 @@ LNXFILE="${KERNEL_IMAGETYPE}${KERNEL_INITRAMFS}-${MACHINE}.bin"
 IMAGE_TEGRAFLASH_KERNEL ?= "${DEPLOY_DIR_IMAGE}/${LNXFILE}"
 BINARY_INSTALL_PATH = "/opt/tegra-binaries"
 
-OS_KERNEL_CMDLINE = "${@bb.utils.contains('DISTRO_FEATURES','osdev-image','console=ttyTHS0,115200n8 console=tty1 debug loglevel=7','console=null quiet splash vt.global_cursor_default=0 consoleblank=0',d)}"
+DTB_OVERLAYS = "\
+    L4TConfiguration.dtbo \
+    L4TRootfsInfo.dtbo \
+    tegra194-p2822-camera-dual-imx274-overlay.dtbo \
+    tegra194-p2822-camera-e3331-overlay.dtbo \
+    tegra194-p2822-camera-e3333-overlay.dtbo \
+    tegra194-p2822-camera-imx185-overlay.dtbo \
+    tegra194-p2822-camera-imx390-overlay.dtbo \
+    tegra194-p2888-0005-overlay.dtbo \
+    tegra194-p2888-0001-p2822-0000-overlay.dtbo \
+"
+
+OS_KERNEL_CMDLINE = "${@bb.utils.contains('DISTRO_FEATURES','osdev-image','console=ttyTHS0,115200n8 console=tty1 ','console=null quiet splash vt.global_cursor_default=0 consoleblank=0',d)} l4tver=${L4T_VERSION}"
 
-BOOTFILES = "\
+BOOTFILES=" \
     adsp-fw.bin \
     bpmp-2_t194.bin \
     camera-rtcpu-t194-rce.img \
@@ -76,13 +89,23 @@ signfile() {
     export CHIPREV=${TEGRA_CHIPREV}
     export sdramcfg=${MACHINE}.cfg,${MACHINE}-override.cfg
 
-    ./tegraflash.py --bl nvtboot_recovery_cpu_t194.bin --sdram_config tegra194-mb1-bct-memcfg-p3668-0001-a00.cfg,tegra194-memcfg-sw-override.cfg  --odmdata 0xB8190000  --overlay_dtb L4TConfiguration.dtbo,tegra194-p3668-p3509-overlay.dtbo,L4TRootfsInfo.dtbo  --bldtb tegra194-p3668-0000-p3509-0000.dtb --applet mb1_t194_prod.bin --cmd "sign" --soft_fuses tegra194-mb1-soft-fuses-l4t.cfg  --cfg flash.xml --chip 0x19 --minratchet_config tegra194-mb1-bct-ratchet-p3668.cfg --device_config tegra19x-mb1-bct-device-qspi-p3668.cfg --misc_cold_boot_config tegra194-mb1-bct-misc-sd-l4t.cfg --misc_config tegra194-mb1-bct-misc-flash.cfg --pinmux_config tegra19x-mb1-pinmux-p3668-a01.cfg --gpioint_config tegra194-mb1-bct-gpioint-p3668-0001-a00.cfg --pmic_config tegra194-mb1-bct-pmic-p3668-0001-a00.cfg --pmc_config tegra19x-mb1-padvoltage-p3668-a01.cfg --prod_config tegra19x-mb1-prod-p3668-0001-a00.cfg --scr_config tegra194-mb1-bct-scr-cbb-mini-p3668.cfg --scr_cold_boot_config tegra194-mb1-bct-scr-cbb-mini-p3668.cfg --br_cmd_config tegra194-mb1-bct-reset-p3668-0001-a00.cfg --dev_params tegra194-br-bct-qspi-l4t.cfg,tegra194-br-bct_b-qspi-l4t.cfg  --bin "mb2_bootloader nvtboot_recovery_t194.bin; mts_preboot preboot_c10_prod_cr.bin; mts_mce mce_c10_prod_cr.bin; mts_proper mts_c10_prod_cr.bin; bpmp_fw bpmp-2_t194.bin; bpmp_fw_dtb tegra194-a02-bpmp-p3668-a00_lz4.dtb; spe_fw spe_t194.bin; tos tos-optee_t194.img; eks eks.img; bootloader_dtb tegra194-p3668-0000-p3509-0000.dtb"   --secondary_gpt_backup  --bct_backup  --boot_chain A
+    ./tegraflash.py --bl nvtboot_recovery_cpu_t194.bin \
+        --sdram_config tegra194-mb1-bct-memcfg-p2888.cfg,tegra194-memcfg-sw-override.cfg  \
+        --odmdata 0x9190000  \
+        --overlay_dtb L4TConfiguration.dtbo,L4TRootfsInfo.dtbo,tegra194-p2822-camera-dual-imx274-overlay.dtbo,tegra194-p2822-camera-e3331-overlay.dtbo,tegra194-p2822-camera-e3333-overlay.dtbo,tegra194-p2822-camera-imx185-overlay.dtbo,tegra194-p2822-camera-imx390-overlay.dtbo,tegra194-p2888-0005-overlay.dtbo,tegra194-p2888-0001-p2822-0000-overlay.dtbo  \
+        --bldtb ${DTBFILE} \
+        --applet mb1_t194_prod.bin --cmd "sign" \
+        --soft_fuses tegra194-mb1-soft-fuses-l4t.cfg  \
+        --cfg flash.xml --chip 0x19 --uphy_config tegra194-mb1-uphy-lane-p2888-0000-p2822-0000.cfg \
+        --minratchet_config tegra194-mb1-bct-ratchet-p2888-0000-p2822-0000.cfg \
+        --device_config tegra19x-mb1-bct-device-sdmmc.cfg --misc_cold_boot_config tegra194-mb1-bct-misc-l4t.cfg --misc_config tegra194-mb1-bct-misc-flash.cfg --pinmux_config tegra19x-mb1-pinmux-p2888-0000-a04-p2822-0000-b01.cfg --gpioint_config tegra194-mb1-bct-gpioint-p2888-0000-p2822-0000.cfg --pmic_config tegra194-mb1-bct-pmic-p2888-0001-a04-E-0-p2822-0000.cfg --pmc_config tegra19x-mb1-padvoltage-p2888-0000-a00-p2822-0000-a00.cfg --prod_config tegra19x-mb1-prod-p2888-0000-p2822-0000.cfg --scr_config tegra194-mb1-bct-scr-cbb-mini.cfg --scr_cold_boot_config tegra194-mb1-bct-scr-cbb-mini.cfg --br_cmd_config tegra194-mb1-bct-reset-p2888-0000-p2822-0000.cfg --dev_params tegra194-br-bct-sdmmc.cfg,tegra194-br-bct_b-sdmmc.cfg  --bin "mb2_bootloader nvtboot_recovery_t194.bin; mts_preboot preboot_c10_prod_cr.bin; mts_mce mce_c10_prod_cr.bin; mts_proper mts_c10_prod_cr.bin; bpmp_fw bpmp-2_t194.bin; bpmp_fw_dtb tegra194-a02-bpmp-p2888-a04_lz4.dtb; spe_fw spe_t194.bin; tos tos-optee_t194.img; eks eks.img; bootloader_dtb ${DTBFILE}"   --secondary_gpt_backup  --bct_backup  --boot_chain A 
+
 }
 
 do_configure() {
-   local destdir="${WORKDIR}/tegraflash"
+    local destdir="${WORKDIR}/tegraflash"
     local lnxfile="${LNXFILE}"
-  local f
+    local f
     PATH="${STAGING_BINDIR_NATIVE}/${FLASHTOOLS_DIR}:${PATH}"
     rm -rf "${WORKDIR}/tegraflash"
     mkdir -p "${WORKDIR}/tegraflash"
@@ -115,17 +138,20 @@ do_configure() {
     done
     cp -r ${DEPLOY_DIR_IMAGE}/*.dtbo .
     cp -r ${DEPLOY_DIR_IMAGE}/*.dtb .
+    for dtbo in ${DTB_OVERLAYS}; do
+        cp "${TMPDIR}/work-shared/L4T-${L4T_BSP_ARCH}-${PV}-${PR}/Linux_for_Tegra/kernel/dtb/${dtbo}" .
+    done
     if [ "${TEGRA_SIGNING_EXCLUDE_TOOLS}" != "1" ]; then
         cp -R ${STAGING_BINDIR_NATIVE}/${FLASHTOOLS_DIR}/* .
     fi
 
     # prepare flash.xml.in to be used in signing
-    cp ${WORKDIR}/resinOS-flash194.xml flash.xml.in
+    cp ${WORKDIR}/resinOS-flash194_nxde.xml flash.xml.in
     sed -i "s, DTB_NAME, ${DTBFILE},g" flash.xml.in
 
     sed -i -e "s/\[DTB_NAME\]/$(echo ${DTBFILE} | cut -d '.' -f 1)/g" ${WORKDIR}/partition_specification194_nxde.txt
 
-   sed -e"s,MB1FILE,mb1_b_t194_prod.bin,2" flash.xml.in | \
+    sed -e"s,MB1FILE,mb1_b_t194_prod.bin,2" flash.xml.in | \
         sed \
         -e"s,LNXFILE_b,$lnxfile," \
         -e"s,LNXFILE,$lnxfile," -e"s,LNXSIZE,${LNXSIZE}," \
@@ -152,39 +178,44 @@ do_configure() {
         > flash.xml
     # prep env for tegraflash
 
+#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/rollback_parser.py ./rollback/
+#    ln -snf ${STAGING_DATADIR}/nv_tegra/rollback/t${@d.getVar('NVIDIA_CHIP')[2:]}x ./rollback/
+#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/BUP_generator.py ./
+#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/${SOC_FAMILY}-flash-helper.sh ./
+
     # bup is based on the rootfs, which is not built at this point
     # not using it for the moment
     # sed -e 's,^function ,,' ${STAGING_BINDIR_NATIVE}/tegra186-flash/l4t_bup_gen.func > ./l4t_bup_gen.func
     rm -rf signed
-
+    echo "35.1.0" > VERFILE
     # Sign all tegra bins
     signfile ""
 
     # Needed to embedd plain initramfs kernel and dtb to main image
     cp ${LNXFILE} ${DEPLOY_DIR_IMAGE}/bootfiles/Image
-    cp ${WORKDIR}/resinOS-flash194.xml ${DEPLOY_DIR_IMAGE}/bootfiles/flash.xml
+    cp ${DTBFILE} ${DEPLOY_DIR_IMAGE}/bootfiles/
+    cp ${WORKDIR}/resinOS-flash194_nxde.xml ${DEPLOY_DIR_IMAGE}/bootfiles/flash.xml
     cp -r signed/* ${DEPLOY_DIR_IMAGE}/bootfiles/
 
-    dd if=/dev/zero count=1 bs=33554432 | tr "\000" "\377" > boot0.img
+    dd if=/dev/zero of=boot0.img bs=8388608 count=1
     #TODO: Signed binary
 
     cp boot0.img ${DEPLOY_DIR_IMAGE}/bootfiles/
-
-
 }
 
+
 do_install() {
     install -d ${D}/${BINARY_INSTALL_PATH}
     cp -r ${S}/tegraflash/signed/* ${D}/${BINARY_INSTALL_PATH}
     rm ${D}/${BINARY_INSTALL_PATH}/boot*im* || true
-    cp ${WORKDIR}/partition_specification194_nxde.txt ${D}/${BINARY_INSTALL_PATH}/
-    # When generating image, this will be default dtb containing cmdline with root set to resin-rootA
+    cp ${WORKDIR}/partition_specification194_nxde.txt ${D}/${BINARY_INSTALL_PATH}/ 
 }
 
 do_deploy() {
-    rm -rf ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
-    mkdir -p ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
-    cp -r ${D}/${BINARY_INSTALL_PATH}/* ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
+    rm -rf ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
+    mkdir -p ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
+    cp -r ${D}/${BINARY_INSTALL_PATH}/* ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
+    cp ${WORKDIR}/partition_specification194_nxde.txt ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
 }
 
 FILES:${PN} += "${BINARY_INSTALL_PATH}"
@@ -204,7 +235,6 @@ do_configure[depends] += " tegra-binaries:do_preconfigure"
 do_configure[depends] += " virtual/kernel:do_deploy \
                            virtual/bootloader:do_deploy \
 "
-do_configure[depends] += " cboot:do_deploy"
 do_configure[depends] += " tos-prebuilt:do_deploy"
 
 do_install[depends] += " virtual/kernel:do_deploy"
@@ -212,4 +242,4 @@ do_populate_lic[depends] += "tegra-binaries:do_unpack"
 
 addtask do_deploy before do_package after do_install
 
-COMPATIBLE_MACHINE = "jetson-xavier-nx-devkit-emmc"
+COMPATIBLE_MACHINE = "jetson-xavier"
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-sdcard-flash_35.1.0.bb b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-sdcard-flash_35.1.0.bb
index 85e3f94..cf86ea0 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-sdcard-flash_35.1.0.bb
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-nxde-sdcard-flash_35.1.0.bb
@@ -5,7 +5,7 @@ LIC_FILES_CHKSUM = "file://${BALENA_COREBASE}/COPYING.Apache-2.0;md5=89aea4e17d9
 
 IMAGE_ROOTFS_ALIGNMENT ?= "4"
 
-BOOT_BINDIFF="boot0_t194_agx_sd.bindiff"
+BOOT_BINDIFF="boot0_t194_nx_sd.bindiff"
 
 DEPENDS = " \
     coreutils-native \
@@ -207,13 +207,13 @@ do_install() {
     install -d ${D}/${BINARY_INSTALL_PATH}
     cp -r ${S}/tegraflash/signed/* ${D}/${BINARY_INSTALL_PATH}
     rm ${D}/${BINARY_INSTALL_PATH}/boot*im* || true
-    cp ${WORKDIR}/partition_specification194_nxde_sdcard.txt ${D}/${BINARY_INSTALL_PATH}/ 
 }
 
 do_deploy() {
     rm -rf ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
     mkdir -p ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
     cp -r ${D}/${BINARY_INSTALL_PATH}/* ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
+    cp ${WORKDIR}/partition_specification194_nxde_sdcard.txt ${DEPLOY_DIR_IMAGE}/$(basename ${BINARY_INSTALL_PATH})
 }
 
 FILES:${PN} += "${BINARY_INSTALL_PATH}"
diff --git a/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra/0007-Add-hup-and-rollback-support-xav-nx-sd.patch b/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra/0007-Add-hup-and-rollback-support-xav-nx.patch
similarity index 100%
rename from layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra/0007-Add-hup-and-rollback-support-xav-nx-sd.patch
rename to layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra/0007-Add-hup-and-rollback-support-xav-nx.patch
diff --git a/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra_35.1.0.bbappend b/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra_35.1.0.bbappend
index 0f1077c..ccfd504 100644
--- a/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra_35.1.0.bbappend
+++ b/layers/meta-balena-jetson/recipes-bsp/uefi/edk2-firmware-tegra_35.1.0.bbappend
@@ -13,7 +13,11 @@ SRC_URI:append:jetson-xavier = " \
 "
 
 SRC_URI:append:jetson-xavier-nx-devkit = " \
-    file://0007-Add-hup-and-rollback-support-xav-nx-sd.patch \
+    file://0007-Add-hup-and-rollback-support-xav-nx.patch \
+"
+
+SRC_URI:append:jetson-xavier-nx-devkit-emmc = " \
+    file://0007-Add-hup-and-rollback-support-xav-nx.patch \
 "
 
 do_deploy:append() {
diff --git a/layers/meta-balena-jetson/recipes-core/images/balena-image.inc b/layers/meta-balena-jetson/recipes-core/images/balena-image.inc
index 37b1555..8cb9009 100644
--- a/layers/meta-balena-jetson/recipes-core/images/balena-image.inc
+++ b/layers/meta-balena-jetson/recipes-core/images/balena-image.inc
@@ -1,13 +1,9 @@
 
-do_rootfs:balenaos-img:jetson-agx-orin-devkit[depends] += " tegra234-flash-dry:do_deploy \
-						edk2-firmware-tegra:do_deploy \
-                                                linux-tegra:do_deploy \
-"
+do_rootfs:balenaos-img:jetson-agx-orin-devkit[depends] += " tegra234-flash-dry:do_deploy "
+do_rootfs:balenaos-img:jetson-xavier-nx-devkit[depends] += " tegra194-nxde-sdcard-flash:do_deploy "
+do_rootfs:balenaos-img:jetson-xavier-nx-devkit-emmc[depends] += " tegra194-nxde-flash-dry:do_deploy "
 
-do_rootfs:balenaos-img:jetson-xavier-nx-devkit[depends] += " tegra194-nxde-sdcard-flash:do_deploy \
-                                                edk2-firmware-tegra:do_deploy \
-                                                linux-tegra:do_deploy \
-"
+do_rootfs:balenaos-img[depends] += " linux-tegra:do_deploy edk2-firmware-tegra:do_deploy l4t-launcher-extlinux:do_deploy "
 
 
 DTBFILE ?= "${@os.path.basename(d.getVar('KERNEL_DEVICETREE', True).split()[0])}"
@@ -54,6 +50,7 @@ IMAGE_INSTALL:append:jetson-xavier-nx-devkit-emmc = " \
     mtd-utils \
     tegra-nvfancontrol \
     l4t-launcher-extlinux \
+    tegra194-nxde-flash-dry \
 "
 
 IMAGE_INSTALL:append:jetson-xavier-nx-devkit = " \
@@ -68,6 +65,7 @@ IMAGE_INSTALL:append:jetson-xavier-nx-devkit = " \
     tegra-firmware-rtl8822 \
     tegra-nvfancontrol \
     l4t-launcher-extlinux \
+    tegra194-nxde-sdcard-flash \
 "
 
 
-- 
2.37.2

