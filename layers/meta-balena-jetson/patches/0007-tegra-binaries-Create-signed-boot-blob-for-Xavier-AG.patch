From 94493c30984d5e37bab29d2403f95de263a36012 Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Tue, 10 Jan 2023 17:00:07 +0100
Subject: [PATCH 07/11] tegra-binaries: Create signed boot blob for Xavier AGX
 HUP

Signed-off-by: Alexandru Costache <alexandru@balena.io>
---
 .../files/boot0_t194_agx.bindiff              | Bin 0 -> 884 bytes
 .../tegra-binaries/files/resinOS-flash194.xml |   2 +-
 .../tegra194-flash-dry_35.1.0.bb              |  88 +++++++++++++++---
 3 files changed, 78 insertions(+), 12 deletions(-)

diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_agx.bindiff b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/boot0_t194_agx.bindiff
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..113b522f0df6f66210d20778682e814d0b87debc 100644
GIT binary patch
literal 884
zcmca-7#uliVeU6Q#p)T0qctq0C2VSDFW}6-{_2P8nd=Rf3}!4091IK$OhAkc^xu?C
ztJrbbYetN1su>S=*1EW<(HY-L9hzsXWOJLJr>(OzoA2u8gC6ZKj%Xj<&M)4#_kkr(
zaG6(+&Q*_Hx5FHNAKDb}edxLSs&h}2b_Ooyd{MQY&D1E&Z!&MPMY8|d`enU|ZaSWk
z?%S$bIs7WMZQ3{t>@Gyyb=;cmVkG*=SH(kcV@>bzM)#g~5q#hC-6Fp2{T}Y$#^kz}
ze=D<6a&nrA)e&3PAC>;grHX4eeP2>8=>5TRv%81en#;c}c=#4e{^K;@o4)XYcWb<x
z^0SuvB4;j}Wl83)^zOW}Mx;1#hJougreJ%2Bj3hbhjUKvGZN%q!S8S8#^JwkL4#?;
z&I8^@c)QGW`)@k;YqG2CI^D=uBYG#I$6}BB9KEL{3;Y*|O*AkIKkOOdG}+yiZ*jGn
zVA;e47W<_f-Pd=X)GC>M!3|rO(o#$<_u?9m`Ty%7wlJbub{{IfZ6|N_grf6aor;TP
zjf`{bVd4!y^&tGtcs>`9A{qFFnQ$p91R0wu=qLoahIs~i`ukZa80r~tIr%#Vxp=zR
z8d+FaD1bS^-l4Vz1_p)-ZjMg2CI$vvMg~U428ITfhGr%Pre<6Q6<{t<Yh;LPu$6_W
Yf^(3wv5}RDqqBjzo2d&f2M)9w04>PdLjV8(

literal 0
HcmV?d00001

diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
index 0ffd877..ddf009b 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/files/resinOS-flash194.xml
@@ -372,7 +372,7 @@
             <percent_reserved> 0 </percent_reserved>
             <description> **Required.** Chain A; contains the Linux kernel. </description>
         </partition>
-        <partition name="kernel-dtb" type="kernel_dtb" oem_sign=true>
+        <partition name="kernel-dtb" type="kernel_dtb" oem_sign="true">
             <allocation_policy> sequential </allocation_policy>
             <filesystem_type> basic </filesystem_type>
             <size> 524288 </size>
diff --git a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
index 9bdb88d..95d633b 100644
--- a/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
+++ b/layers/meta-balena-jetson/recipes-bsp/tegra-binaries/tegra194-flash-dry_35.1.0.bb
@@ -5,7 +5,7 @@ LIC_FILES_CHKSUM = "file://${BALENA_COREBASE}/COPYING.Apache-2.0;md5=89aea4e17d9
 
 IMAGE_ROOTFS_ALIGNMENT ?= "4"
 
-BOOT_BINDIFF="boot0_t194_nx.bindiff"
+BOOT_BINDIFF="boot0_t194_agx.bindiff"
 
 DEPENDS = " \
     coreutils-native \
@@ -164,11 +164,6 @@ do_configure() {
         > flash.xml
     # prep env for tegraflash
 
-#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/rollback_parser.py ./rollback/
-#    ln -snf ${STAGING_DATADIR}/nv_tegra/rollback/t${@d.getVar('NVIDIA_CHIP')[2:]}x ./rollback/
-#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/BUP_generator.py ./
-#    ln -sf ${STAGING_BINDIR_NATIVE}/tegra186-flash/${SOC_FAMILY}-flash-helper.sh ./
-
     # bup is based on the rootfs, which is not built at this point
     # not using it for the moment
     # sed -e 's,^function ,,' ${STAGING_BINDIR_NATIVE}/tegra186-flash/l4t_bup_gen.func > ./l4t_bup_gen.func
@@ -177,14 +172,82 @@ do_configure() {
     # Sign all tegra bins
     signfile ""
 
-    # Needed to embedd plain initramfs kernel and dtb to main image
-    cp ${LNXFILE} ${DEPLOY_DIR_IMAGE}/bootfiles/Image
+    rm ${DEPLOY_DIR_IMAGE}/Image || true
     cp ${WORKDIR}/resinOS-flash194.xml ${DEPLOY_DIR_IMAGE}/bootfiles/flash.xml
     cp -r signed/* ${DEPLOY_DIR_IMAGE}/bootfiles/
 
     dd if=/dev/zero of=boot0.img bs=8388608 count=1
-    #TODO: Signed binary
-
+    # BCT (a)
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/br_bct_BR.bct of=boot0.img conv=notrunc
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/br_bct_BR.bct of=boot0.img seek=3072 bs=1 conv=notrunc
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/br_bct_BR.bct of=boot0.img seek=16384 bs=1 conv=notrunc
+
+    # mb1 (a + b)
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mb1_t194_prod_aligned_sigheader.bin.encrypt of=boot0.img seek=32768 bs=1 conv=notrunc
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mb1_t194_prod_aligned_sigheader.bin.encrypt of=boot0.img seek=294912 bs=1 conv=notrunc
+
+    #MB1_BCT
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mb1_cold_boot_bct_MB1_sigheader.bct.encrypt of=boot0.img seek=557056 bs=1 conv=notrunc
+
+    #MEM_BCT
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mem_coldboot_sigheader.bct.encrypt of=boot0.img seek=622592 bs=1 conv=notrunc
+
+    #spe_fw
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/spe_t194_sigheader.bin.encrypt of=boot0.img seek=851968 bs=1 conv=notrunc
+
+    #mb2
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/nvtboot_t194_sigheader.bin.encrypt of=boot0.img seek=1114112 bs=1 conv=notrunc
+
+    #mts-preboot
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/preboot_c10_prod_cr_sigheader.bin.encrypt of=boot0.img seek=1343488 bs=1 conv=notrunc
+
+    #MB1_BCT_b
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mb1_cold_boot_bct_MB1_sigheader.bct.encrypt of=boot0.img seek=3473408 bs=1 conv=notrunc
+
+    #MEM_BCT_b
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/mem_coldboot_sigheader.bct.encrypt of=boot0.img seek=3538944 bs=1 conv=notrunc
+
+    #spe_fw_b
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/spe_t194_sigheader.bin.encrypt of=boot0.img seek=3768320 bs=1 conv=notrunc
+
+    #mb2_b
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/nvtboot_t194_sigheader.bin.encrypt of=boot0.img seek=4030464 bs=1 conv=notrunc
+
+    #mts-preboot_b
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/preboot_c10_prod_cr_sigheader.bin.encrypt of=boot0.img seek=4259840 bs=1 conv=notrunc
+
+    #BCT-boot-chain_backup
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/bct_backup.img of=boot0.img seek=7995392 bs=1 conv=notrunc
+
+    #secondary_gpt_backup
+    dd if=${DEPLOY_DIR_IMAGE}/bootfiles/gpt_secondary_0_3.bin of=boot0.img seek=8126464 bs=1 conv=notrunc
+
+    cp ${WORKDIR}/${BOOT_BINDIFF} .
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=32784 skip=0 bs=1 count=32 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=35776 skip=32 bs=1 count=32 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8126480 skip=64 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8126608 skip=80 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8126736 skip=96 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8126864 skip=112 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8126992 skip=128 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127120 skip=144 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127248 skip=160 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127376 skip=176 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127504 skip=192 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127632 skip=208 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127760 skip=224 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8127888 skip=240 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128016 skip=256 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128144 skip=272 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128272 skip=288 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128400 skip=304 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128528 skip=320 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128656 skip=336 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128784 skip=352 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8128912 skip=368 bs=1 count=16 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8142864 skip=496 bs=1 count=128 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8192000 skip=624 bs=1 count=128 conv=notrunc
+    dd if=${BOOT_BINDIFF} of=boot0.img seek=8257536 skip=756 bs=1 count=128 conv=notrunc
     cp boot0.img ${DEPLOY_DIR_IMAGE}/bootfiles/
 }
 
@@ -193,13 +256,16 @@ do_install() {
     install -d ${D}/${BINARY_INSTALL_PATH}
     cp -r ${S}/tegraflash/signed/* ${D}/${BINARY_INSTALL_PATH}
     rm ${D}/${BINARY_INSTALL_PATH}/boot*im* || true
-    cp ${WORKDIR}/partition_specification194.txt ${D}/${BINARY_INSTALL_PATH}/    
+    cp -r ${DEPLOY_DIR_IMAGE}/bootfiles/* ${D}/${BINARY_INSTALL_PATH}/
+    cp ${WORKDIR}/partition_specification194.txt ${D}/${BINARY_INSTALL_PATH}/
+    rm ${D}/${BINARY_INSTALL_PATH}/Image || true 
 }
 
 do_deploy() {
     rm -rf ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
     mkdir -p ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
     cp -r ${D}/${BINARY_INSTALL_PATH}/* ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})
+    rm ${DEPLOYDIR}/$(basename ${BINARY_INSTALL_PATH})/Image || true
 }
 
 FILES:${PN} += "${BINARY_INSTALL_PATH}"
-- 
2.37.2

